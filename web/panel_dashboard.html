<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ guild_name }} - Staff Dashboard</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/png" href="/static/icon.png">
    <style>
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        .leaderboard-card { grid-column: span 1; }
        .stats-column { grid-column: span 1; display: flex; flex-direction: column; gap: 1.5rem; }
        .leaderboard-card { display: flex; flex-direction: column; }
        .leaderboard-content-wrapper { display: flex; flex-direction: column; justify-content: space-between; flex-grow: 1; }
        .leaderboard-content-wrapper .stat-list { flex-grow: 1; }
        .leaderboard-content-wrapper .button { flex-shrink: 0; }
    </style>
</head>
<body class="body-fade-in">

    <script>
        (function() {
            const body = document.body;
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'light') {
                body.classList.add('light-mode');
            }
        })();
    </script>

    <header class="top-bar">
        <div class="logo">
            <img src="/static/Logo-DayMode.png" alt="Logo" class="logo-light-mode">
            <img src="/static/Logo-NightMode.png" alt="Logo" class="logo-dark-mode">
        </div>
        <div class="user-profile">
            <img src="{{ user_avatar_url }}" alt="User Avatar">
            <span>{{ user_name }}</span>
            <span class="access-badge">{{ access_level }} Access</span>

            <button id="theme-toggle-btn" class="icon-button">‚òÄÔ∏è</button>

            <a href="{{ url_for('logout', guild_id=guild_id) }}" class="icon-button logout-button" aria-label="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22px" height="22px">
                    <path fill-rule="evenodd" d="M7.5 3.75A1.5 1.5 0 006 5.25v13.5A1.5 1.5 0 007.5 20.25h3.75a.75.75 0 000-1.5H7.5a.75.75 0 010-1.5h3.75a.75.75 0 000-1.5H7.5a.75.75 0 010-1.5h3.75a.75.75 0 000-1.5H7.5a.75.75 0 010-1.5h3.75a.75.75 0 000-1.5H7.5a.75.75 0 010-1.5h3.75a.75.75 0 000-1.5H7.5A1.5 1.5 0 006 5.25z" clip-rule="evenodd" />
                    <path d="M13.06 8.22a.75.75 0 011.06 0l3.75 3.75a.75.75 0 010 1.06l-3.75 3.75a.75.75 0 11-1.06-1.06l2.47-2.47H9.75a.75.75 0 010-1.5h5.78l-2.47-2.47a.75.75 0 010-1.06z" />
                </svg>
            </a>
        </div>
    </header>

    <main class="main-content">
        <h2>Dashboard</h2>
        <div class="dashboard-grid">
            <div class="card leaderboard-card">
                <h3>XP Leaderboard</h3>
                <div class="leaderboard-content-wrapper">
                    <ul class="stat-list">
                        {% for user in xp_leaderboard %}
                        <li>{{ user.name }}<span>{{ user.score }} XP</span></li>
                        {% else %}
                        <li>No XP data yet.</li>
                        {% endfor %}
                    </ul>
                    <a href="{{ url_for('xp_leaderboard', guild_id=guild_id) }}" target="_blank" class="button" style="margin-top: 1rem;">Open in New Page</a>
                </div>
            </div>

            <div class="stats-column">
                <div class="card stat-item" style="margin: 0;">
                    <div class="stat-label">Last Member Joined</div>
                    <div class="stat-value">{{ last_member }}</div>
                </div>
                <div class="card stat-item" style="margin: 0;">
                    <div class="stat-label">Users Online</div>
                    <div class="stat-value">{{ online_count }}</div>
                </div>
                <div class="card stat-item" style="margin: 0;">
                    <div class="stat-label">Member Count</div>
                    <div class="stat-value">{{ member_count }}</div>
                </div>
            </div>
        </div>
    </main>

    <nav class="bottom-bar">
        <a href="{{ url_for('panel_home', guild_id=guild_id) }}" class="active">Dashboard</a>
        <a href="{{ url_for('panel_widgets', guild_id=guild_id) }}">Widgets</a>
        <a href="{{ url_for('panel_mod_menu', guild_id=guild_id) }}">Mod Menu</a>
    </nav>

    <script>
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const body = document.body;
        const currentTheme = localStorage.getItem('theme');

        if (currentTheme === 'light') {
            body.classList.add('light-mode');
            themeToggleBtn.textContent = 'üåô';
        } else {
            body.classList.remove('light-mode');
            themeToggleBtn.textContent = '‚òÄÔ∏è';
        }

        themeToggleBtn.addEventListener('click', () => {
            body.classList.toggle('light-mode');
            
            if (body.classList.contains('light-mode')) {
                themeToggleBtn.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            } else {
                themeToggleBtn.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.bottom-bar a, .top-bar a.logout-button');

            navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    const href = link.getAttribute('href');

                    if (href && href.startsWith('/') && !e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        
                        document.body.classList.add('body-fade-out');

                        setTimeout(() => {
                            window.location.href = href;
                        }, 300);
                    }
                });
            });
        });
    </script>
</body>
</html>